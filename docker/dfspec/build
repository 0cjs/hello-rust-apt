#   This image builds the program to be packaged.

include(10-base)
include(15-package-db-update)
include(20-debug-packages)
include(30-build-packages)
include(60-user-setup)

ADD --chown=$USER_UID webhello.tar.gz image-build/
#   Rust build notes:
#   â€¢ webhello/ builds into ../.build/cargo/webhello. But we still need to
#     create that directory before we `cargo build` other the
#     webhello/Cargo.lock symlink will fail.
RUN    cd image-build/webhello \
    && source ../docker/rustup-env \
    && mkdir -p ../.build/cargo/webhello/ \
    && cargo build \
    && true

#   Run all pre-release tests.
#   We would run unit tests here as well if we had them.
ADD --chown=$USER_UID hello-server-test image-build/
RUN    image-build/webhello/cargo-start-server \
    && image-build/hello-server-test \
    && true

RUN image-build/package/make-package
